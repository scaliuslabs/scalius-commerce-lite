#!/usr/bin/env node
// scripts/build-with-queue.mjs
// Post-build script: wraps the Astro-generated worker with a queue consumer.
// 
// Usage: Run AFTER `astro build` to create dist/worker-with-queue.js
// The resulting file exports both `fetch` (Astro handler) and `queue` (our consumer).

import { writeFileSync, existsSync } from "fs";
import { resolve } from "path";
import { execSync } from "child_process";

const distDir = resolve(process.cwd(), "dist");
const astroWorkerPath = resolve(distDir, "_worker.js/index.js");

if (!existsSync(astroWorkerPath)) {
  console.error(
    "[build-with-queue] ERROR: Astro worker not found at",
    astroWorkerPath,
  );
  console.error(
    "[build-with-queue] Run `astro build` first before this script.",
  );
  process.exit(1);
}

// Bundle our queue consumer to dist/queue-consumer.js using esbuild
console.log("[build-with-queue] Bundling queue consumer...");
try {
  execSync(
    [
      "npx esbuild",
      "src/queue-consumer.ts",
      "--bundle",
      "--platform=browser",
      "--target=esnext",
      "--format=esm",
      "--external:cloudflare:workers",
      "--outfile=dist/queue-consumer.js",
      "--tsconfig=tsconfig.json",
    ].join(" "),
    { stdio: "inherit" },
  );
  console.log("[build-with-queue] Queue consumer bundled to dist/queue-consumer.js");
} catch (err) {
  console.error("[build-with-queue] Failed to bundle queue consumer:", err.message);
  process.exit(1);
}

// Create the wrapper entry point
const wrapperContent = `// dist/worker-with-queue.js
// Auto-generated by scripts/build-with-queue.mjs
// Wraps the Astro worker with Cloudflare Queue support.

import astroWorker from "./_worker.js/index.js";
import { handleQueueBatch } from "./queue-consumer.js";

export default {
  async fetch(request, env, ctx) {
    return astroWorker.fetch(request, env, ctx);
  },

  async queue(batch, env, ctx) {
    return handleQueueBatch(batch, env);
  },
};
`;

const wrapperPath = resolve(distDir, "worker-with-queue.js");
writeFileSync(wrapperPath, wrapperContent, "utf-8");
console.log("[build-with-queue] Created dist/worker-with-queue.js");
console.log(
  "[build-with-queue] Update wrangler.jsonc main to './dist/worker-with-queue.js' before deploying.",
);
