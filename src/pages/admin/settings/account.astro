---
// src/pages/admin/settings/account.astro
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { AccountSettingsWithPermissions } from "../../../components/admin/AccountSettingsWithPermissions";
import { getDb } from "@/db";
import { user as userTable } from "@/db/schema";
import { eq } from "drizzle-orm";

// Get user from middleware
const user = Astro.locals.user;

// Redirect if not authenticated (handled by AdminLayout, but just in case)
if (!user) {
  return Astro.redirect("/auth/login");
}

// Fetch twoFactorMethod and isSuperAdmin from database
const env = Astro.locals.runtime?.env || process.env;
const db = getDb(env);
const dbUser = await db
  .select({
    twoFactorMethod: userTable.twoFactorMethod,
    isSuperAdmin: userTable.isSuperAdmin
  })
  .from(userTable)
  .where(eq(userTable.id, user.id))
  .get();

// Prepare user data for the component
const userData = {
  id: user.id,
  name: user.name,
  email: user.email,
  image: user.image,
  role: user.role,
  twoFactorEnabled: user.twoFactorEnabled,
  twoFactorMethod: dbUser?.twoFactorMethod || null,
};

// Get permissions from middleware
const permissions = Astro.locals.permissions;
const permissionsArray = permissions ? Array.from(permissions) : [];
const isSuperAdmin = dbUser?.isSuperAdmin ?? false;
---

<AdminLayout title="Account Settings">
  <div class="max-w-3xl mx-auto">
    <div class="mb-8">
      <h1 class="text-2xl font-bold">Account Settings</h1>
      <p class="text-sm text-muted-foreground mt-1">
        Manage your account security and administrator access
      </p>
    </div>

    <AccountSettingsWithPermissions
      user={userData}
      permissions={permissionsArray}
      isSuperAdmin={isSuperAdmin}
      client:idle
    />
  </div>
</AdminLayout>
