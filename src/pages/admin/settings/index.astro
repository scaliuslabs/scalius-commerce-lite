---
// src/pages/admin/settings/index.astro
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { HeaderBuilder } from "../../../components/admin/header-builder";
import { FooterBuilder } from "../../../components/admin/footer-builder";
import { SeoSettingsBuilder } from "../../../components/admin/SeoSettingsBuilder";
import { StorefrontUrlBuilder } from "../../../components/admin/StorefrontUrlBuilder";
import { SecuritySettingsBuilder } from "../../../components/admin/SecuritySettingsBuilder";
import EmailSettingsForm from "../../../components/admin/settings/EmailSettingsForm";
import { db } from "../../../db";
import { siteSettings } from "../../../db/schema";

// Get existing settings
const [settings] = await db.select().from(siteSettings).limit(1);

// Safely parse JSON with fallback to null
const safeParseJSON = (jsonString: string | null | undefined) => {
  if (!jsonString) return null;
  try {
    return JSON.parse(jsonString);
  } catch (error) {
    console.error("Error parsing JSON:", error);
    return null;
  }
};

// Parse header and footer configurations
const headerConfig = safeParseJSON(settings?.headerConfig) || {};
const footerConfig = safeParseJSON(settings?.footerConfig) || {};
---

<AdminLayout title="Site Settings">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Site Appearance & SEO Settings</h1>
    <p class="text-sm text-muted-foreground mb-8">
      Configure your site's appearance, navigation, SEO, and storefront
      settings. Click on any section to expand.
    </p>

    <div class="space-y-4" data-accordion-wrapper>
      <div
        class="bg-card rounded-xl border border-border shadow-sm overflow-hidden"
      >
        <details class="group" open>
          <summary
            class="cursor-pointer list-none border-b border-border bg-muted/5 px-6 py-4 hover:bg-muted/10 transition-colors"
          >
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Header Configuration</h2>
                <p class="text-sm text-muted-foreground mt-1">
                  Customize your site's header appearance, navigation, and
                  functionality
                </p>
              </div>
              <svg
                class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="p-6">
            <HeaderBuilder client:idle initialConfig={headerConfig} />
          </div>
        </details>
      </div>

      <div
        class="bg-card rounded-xl border border-border shadow-sm overflow-hidden"
      >
        <details class="group">
          <summary
            class="cursor-pointer list-none border-b border-border bg-muted/5 px-6 py-4 hover:bg-muted/10 transition-colors"
          >
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Footer Configuration</h2>
                <p class="text-sm text-muted-foreground mt-1">
                  Customize your site's footer appearance, navigation, and
                  contact information
                </p>
              </div>
              <svg
                class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="p-6">
            <FooterBuilder client:idle initialConfig={footerConfig} />
          </div>
        </details>
      </div>

      <div
        class="bg-card rounded-xl border border-border shadow-sm overflow-hidden"
      >
        <details class="group">
          <summary
            class="cursor-pointer list-none border-b border-border bg-muted/5 px-6 py-4 hover:bg-muted/10 transition-colors"
          >
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">SEO Configuration</h2>
                <p class="text-sm text-muted-foreground mt-1">
                  Manage global SEO settings and robots.txt for your site
                </p>
              </div>
              <svg
                class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="p-6">
            <SeoSettingsBuilder client:idle />
          </div>
        </details>
      </div>

      <div
        class="bg-card rounded-xl border border-border shadow-sm overflow-hidden"
      >
        <details class="group">
          <summary
            class="cursor-pointer list-none border-b border-border bg-muted/5 px-6 py-4 hover:bg-muted/10 transition-colors"
          >
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Storefront Configuration</h2>
                <p class="text-sm text-muted-foreground mt-1">
                  Configure your storefront URL for the "View Store" link
                </p>
              </div>
              <svg
                class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="p-6">
            <StorefrontUrlBuilder client:idle />
          </div>
        </details>
      </div>

      <div
        class="bg-card rounded-xl border border-border shadow-sm overflow-hidden"
      >
        <details class="group">
          <summary
            class="cursor-pointer list-none border-b border-border bg-muted/5 px-6 py-4 hover:bg-muted/10 transition-colors"
          >
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Email Configuration</h2>
                <p class="text-sm text-muted-foreground mt-1">
                  Configure transactional email delivery (Resend API key and
                  sender address)
                </p>
              </div>
              <svg
                class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="p-6">
            <EmailSettingsForm client:idle />
          </div>
        </details>
      </div>

      <div
        class="bg-card rounded-xl border border-border shadow-sm overflow-hidden"
      >
        <details class="group">
          <summary
            class="cursor-pointer list-none border-b border-border bg-muted/5 px-6 py-4 hover:bg-muted/10 transition-colors"
          >
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Security & CORS Configuration</h2>
                <p class="text-sm text-muted-foreground mt-1">
                  Manage allowed domains for CORS and Content Security Policy (CSP) headers.
                </p>
              </div>
              <svg
                class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </summary>
          <div class="p-6">
            <SecuritySettingsBuilder client:idle={true} />
          </div>
        </details>
      </div>
    </div>
  </div>
</AdminLayout>
