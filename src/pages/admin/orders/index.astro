---
// src/pages/admin/orders/index.astro
import AdminLayout from "@/layouts/AdminLayout.astro";
import { OrderList } from "@/components/admin/OrderList";
import { getOrders } from "@/lib/admin";
import type { OrderListItem } from "@/lib/admin";
import { db } from "@/db";
import { deliveryLocations } from "@/db/schema";
import { and, isNull, sql } from "drizzle-orm";

const searchParams = Astro.url.searchParams;
const page = parseInt(searchParams.get("page") || "1");
const limit = parseInt(searchParams.get("limit") || "10");
const search = searchParams.get("search") || "";
const status = searchParams.get("status") || undefined;
const showTrashed = searchParams.get("trashed") === "true";
const sort = (searchParams.get("sort") || "updatedAt") as
  | "customerName"
  | "totalAmount"
  | "status"
  | "createdAt"
  | "updatedAt";
const order = (searchParams.get("order") || "desc") as "asc" | "desc";

// Get orders with proper sorting and trash handling
const { orders, pagination } = await getOrders({
  page,
  search,
  status,
  sort,
  order,
  showTrashed,
  limit,
});

// Get all unique location IDs from the orders to fetch their names in one go
const locationIds = [
  ...new Set(
    orders
      .flatMap((order) => [order.city, order.zone, order.area])
      .filter(Boolean) as string[],
  ),
];

const locationMap = new Map<string, string>();

if (locationIds.length > 0) {
  // Get all locations that match the IDs
  const locationResults = await db
    .select({
      id: deliveryLocations.id,
      name: deliveryLocations.name,
    })
    .from(deliveryLocations)
    .where(
      and(
        sql`${deliveryLocations.id} IN (${locationIds.join(",")})`,
        isNull(deliveryLocations.deletedAt),
      ),
    );

  // Create a map of ID to location name
  locationResults.forEach((location) => {
    locationMap.set(location.id, location.name);
  });
}

// Ensure all dates are properly instantiated and enrich orders with location names
const formattedOrders: OrderListItem[] = orders.map((order) => {
  const cityId = order.city ?? "";
  const zoneId = order.zone ?? "";

  return {
    ...order,
    createdAt:
      order.createdAt instanceof Date
        ? order.createdAt
        : new Date(order.createdAt),
    updatedAt:
      order.updatedAt instanceof Date
        ? order.updatedAt
        : new Date(order.updatedAt),

    // Provide safe fallbacks to ensure type correctness.
    // Priority: DB name ?? Looked-up name ?? ID
    cityName: order.cityName ?? locationMap.get(cityId) ?? cityId,
    zoneName: order.zoneName ?? locationMap.get(zoneId) ?? zoneId,
    
    // Area can be null
    areaName: order.areaName ?? (order.area ? locationMap.get(order.area) ?? order.area : null),
    
    // Ensure city and zone are not null for type safety, as they are required fields.
    city: cityId,
    zone: zoneId,
  };
});
---

<AdminLayout title={showTrashed ? "Trash" : "Orders"}>
  <OrderList
    client:idle
    orders={formattedOrders}
    pagination={pagination}
    initialSearchQuery={search}
    initialSort={{ field: sort, order }}
    showTrashed={showTrashed}
  />
</AdminLayout>