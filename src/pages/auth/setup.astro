---
// src/pages/auth/setup.astro
// SECURITY: This page is ONLY accessible when no admin users exist
import AuthLayout from "@/layouts/AuthLayout.astro";
import { SetupForm } from "@/components/auth/SetupForm";
import { getDb } from "@/db";
import { user } from "@/db/schema";
import { count, eq } from "drizzle-orm";

// Get environment from Astro context (Cloudflare Workers)
const env = Astro.locals.runtime?.env || process.env;

// SECURITY: Check if any ADMIN users exist (not just any users)
// This ensures the setup page is only accessible during initial deployment
const db = getDb(env);
const adminResult = await db
  .select({ count: count() })
  .from(user)
  .where(eq(user.role, "admin"));
const adminExists = adminResult[0]?.count > 0;

// If an admin already exists, redirect to login - setup is not allowed
if (adminExists) {
  return Astro.redirect("/auth/login");
}
---

<AuthLayout title="Setup">
  <SetupForm client:load />
</AuthLayout>
