---
// src/layouts/AdminLayout.astro
import { Breadcrumb } from "@/components/ui/breadcrumb";
import { UserMenu } from "@/components/auth/UserMenu";
import {
  LayoutDashboard,
  ShoppingCart,
  FolderTree,
  ListTree,
  Layers3,
  Images,
  FileText,
  Blocks,
  Menu,
  Settings,
  SlidersHorizontal,
  MapPinned,
  Truck,
  PackageCheck,
  Database,
  ShoppingBag,
  BadgePercent,
  BarChart3,
  Users,
  PanelLeftClose,
  PanelLeftOpen,
  Globe,
  ShieldCheck,
  Clock3,
  Bell,
  UserCog,
} from "lucide-react";

import { Toaster as ShadcnToaster } from "@/components/ui/toaster";
import { Toaster as SonnerToaster } from "@/components/ui/sonner";
import "../styles/global.css";
import { DarkModeToggle } from "@/components/ui/DarkModeToggle";
import { Button } from "@/components/ui/button.tsx";
import SideBar from "@/components/admin/adminLayout/SideBar.astro";
import { generateAdminBreadcrumbs } from "@/lib/adminBreadCrumb";
import favicon from "@/assets/favicon.png";

interface Props {
  title: string;
}

const { title } = Astro.props;

// Get current path
const currentPath = Astro.url.pathname;

// Get user and session from middleware
const user = Astro.locals.user;
const session = Astro.locals.session;

// Redirect to login if not authenticated
if (!user || !session) {
  return Astro.redirect("/auth/login");
}

// Firebase config setup
import { db } from "@/db";
import { settings } from "@/db/schema";
import { eq, and } from "drizzle-orm";

let firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
  measurementId: import.meta.env.PUBLIC_FIREBASE_MEASUREMENT_ID,
  vapidKey: import.meta.env.PUBLIC_VAPID_FIREBASE,
};

try {
  const result = await db
    .select({ value: settings.value })
    .from(settings)
    .where(and(eq(settings.key, "public_config"), eq(settings.category, "firebase")))
    .get();

  if (result && result.value) {
    const dbConfig = JSON.parse(result.value);
    // Merge DB config, overriding env vars if present
    firebaseConfig = { ...firebaseConfig, ...dbConfig };
    // Map vapidKey from likely json key "vapidKey"
    if (dbConfig.vapidKey) firebaseConfig.vapidKey = dbConfig.vapidKey;
  }
} catch (e) {
  console.error("Error loading Firebase settings in layout:", e);
}

// Generate breadcrumb items using helper function
const breadcrumbItems = generateAdminBreadcrumbs(currentPath);

// Define nav item types for type safety
export interface NavSubItem {
  name: string;
  href: string;
  icon?: any;
}
export interface NavItem {
  name: string;
  href: string;
  icon: any;
  subItems?: NavSubItem[];
}
export interface NavSection {
  label: string;
  items: NavItem[];
}

const navSections: NavSection[] = [
  {
    label: "Commerce",
    items: [
      { name: "Dashboard", href: "/admin", icon: LayoutDashboard },
      { name: "Products", href: "/admin/products", icon: ShoppingCart },
      { name: "Categories", href: "/admin/categories", icon: FolderTree },
      { name: "Attributes", href: "/admin/attributes", icon: ListTree },
      { name: "Collections", href: "/admin/collections", icon: Layers3 },
      { name: "Media", href: "/admin/media", icon: Images },
      { name: "Pages", href: "/admin/pages", icon: FileText },
      { name: "Widgets", href: "/admin/widgets", icon: Blocks },
    ],
  },
  {
    label: "Sales",
    items: [
      { name: "Orders", href: "/admin/orders", icon: ShoppingBag },
      {
        name: "Incomplete Orders",
        href: "/admin/abandoned-checkouts",
        icon: Clock3,
      },
      { name: "Discounts", href: "/admin/discounts", icon: BadgePercent },
      { name: "Analytics", href: "/admin/analytics", icon: BarChart3 },
      { name: "Customers", href: "/admin/customers", icon: Users },
    ],
  },
  {
    label: "Settings",
    items: [
      {
        name: "Settings",
        href: "/admin/settings",
        icon: Settings,
        subItems: [
          {
            name: "General",
            href: "/admin/settings",
            icon: SlidersHorizontal,
          },
          {
            name: "Account",
            href: "/admin/settings/account",
            icon: UserCog,
          },
          {
            name: "Notifications",
            href: "/admin/settings/notifications",
            icon: Bell,
          },
          {
            name: "Hero Sliders",
            href: "/admin/settings/hero-sliders",
            icon: Images,
          },
          {
            name: "Delivery Locations",
            href: "/admin/settings/delivery-locations",
            icon: MapPinned,
          },
          {
            name: "Delivery Providers",
            href: "/admin/settings/delivery-providers",
            icon: Truck,
          },
          {
            name: "Fraud Checker",
            href: "/admin/settings/fraud-checker",
            icon: ShieldCheck,
          },
          {
            name: "Shipping Methods",
            href: "/admin/settings/shipping-methods",
            icon: PackageCheck,
          },
          {
            name: "Checkout Languages",
            href: "/admin/settings/checkout-languages",
            icon: Globe,
          },
          {
            name: "Meta Conversions",
            href: "/admin/settings/meta-conversion",
            icon: BarChart3,
          },
          {
            name: "Cache Settings",
            href: "/admin/settings/cache",
            icon: Database,
          },
        ],
      },
    ],
  },
];

// Prepare user data for UserMenu component
const userData = {
  id: user.id,
  name: user.name,
  email: user.email,
  image: user.image,
  role: user.role,
  twoFactorEnabled: user.twoFactorEnabled,
  isSuperAdmin: (user as any).isSuperAdmin ?? false,
};

// Get user permissions from middleware
const permissions = Astro.locals.permissions;
const permissionsArray = permissions ? Array.from(permissions) : [];
---

<html lang="en" class="antialiased">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      const theme = (() => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        // Default to light mode instead of following system preference
        return "light";
      })();

      if (theme === "light") {
        document.documentElement.classList.remove("dark");
      } else {
        document.documentElement.classList.add("dark");
      }
      document.documentElement.style.setProperty("color-scheme", theme);
    </script>
    <link rel="icon" type="image/png" href={favicon.src} />
    <meta name="generator" content={Astro.generator} />
    <title>{title} - Scalius Admin</title>
  </head>
  <body
    data-current-path={Astro.url.pathname}
    class="bg-background text-foreground transition-colors duration-200"
  >
    <div class="flex min-h-screen">
      <SideBar navSections={navSections} currentPath={currentPath} />

      <!-- Main content -->
      <div class="flex-1 flex flex-col min-h-screen">
        <!-- Header -->
        <header
          class="h-14 border-b border-border px-4 flex items-center justify-between sticky top-0 z-30 backdrop-blur-sm bg-background/95 transition-all duration-200"
        >
          <div class="flex items-center gap-3">
            <Button
              variant="ghost"
              size="icon"
              id="sidebar-toggle"
              aria-label="Toggle sidebar"
              className="md:hidden h-9 w-9 text-muted-foreground hover:text-foreground hover:bg-muted"
            >
              <Menu className="w-5! h-5!" />
            </Button>

            <Button
              variant="ghost"
              size="icon"
              id="sidebar-collapse"
              aria-label="Collapse sidebar"
              className="hidden md:flex h-8 w-8 text-muted-foreground hover:text-foreground hover:bg-muted"
            >
              <PanelLeftClose className="w-6! h-6! sidebar-icon-expanded" />
              <PanelLeftOpen
                className="w-6! h-6!  sidebar-icon-collapsed hidden"
              />
            </Button>

            <Breadcrumb items={breadcrumbItems} client:load />
          </div>
          <div class="flex items-center gap-12">
            <DarkModeToggle
              client:load
              className="h-8 w-8 p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md transition-colors"
            />
            <UserMenu user={userData} client:load />
          </div>
        </header>

        <!-- Main content area -->
        <main
          class="flex-1 p-6 transition-all duration-200"
          id="main-content"
        >
          <div class="max-w-7xl mx-auto">
            <slot />
          </div>
        </main>
      </div>
    </div>

    <ShadcnToaster client:load />
    <SonnerToaster richColors closeButton client:load />

    <script>
      function initializeSidebarControls() {
        const sidebarToggleBtn = document.getElementById("sidebar-toggle");
        const sidebarCollapseBtn = document.getElementById("sidebar-collapse");

        if (sidebarToggleBtn) {
          sidebarToggleBtn.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("toggleMobileSidebar"));
          });
        }

        if (sidebarCollapseBtn) {
          sidebarCollapseBtn.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("toggleSidebarCollapse"));
          });
        }
      }

      // Initialize immediately if DOM is ready, otherwise wait for it
      if (document.readyState === "loading") {
        document.addEventListener(
          "DOMContentLoaded",
          initializeSidebarControls
        );
      } else {
        initializeSidebarControls();
      }
    </script>

    <script define:vars={{ firebaseConfig, userId: user.id, permissions: permissionsArray, isSuperAdmin: userData.isSuperAdmin }}>
      // Store config in window for the module script to access
      window.__FIREBASE_CONFIG__ = firebaseConfig;
      window.__USER_ID__ = userId;
      // Store permissions for React components
      window.__USER_PERMISSIONS__ = permissions;
      window.__IS_SUPER_ADMIN__ = isSuperAdmin;
    </script>

    <script>
      // This script runs as a module (Firebase notifications)
      import { initFirebaseClientNotifications } from "@/lib/firebase/client";

      function initializeFcmOnClient() {
        console.log("AdminLayout: initializeFcmOnClient called");
        const firebaseConfig = (window as any).__FIREBASE_CONFIG__;
        const userId = (window as any).__USER_ID__;

        if (!firebaseConfig || !firebaseConfig.apiKey) {
          console.error("AdminLayout: Firebase config not found or invalid");
          return;
        }

        if (!userId) {
          console.warn("AdminLayout: User ID not available. FCM not initialized.");
          return;
        }

        console.log("AdminLayout: Initializing FCM with userId:", userId);
        initFirebaseClientNotifications(userId, firebaseConfig);
      }

      if (document.readyState === "complete") {
        initializeFcmOnClient();
      } else {
        window.addEventListener("load", initializeFcmOnClient);
      }
    </script>
  </body>
</html>
