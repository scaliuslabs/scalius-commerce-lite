---
// src/layouts/AdminLayout.astro
import { Breadcrumb } from "@/components/ui/breadcrumb";
import { UserMenu } from "@/components/auth/UserMenu";
import {
  LayoutDashboard,
  ShoppingCart,
  FolderTree,
  ListTree,
  Layers3,
  Images,
  FileText,
  Blocks,
  Menu,
  Settings,
  SlidersHorizontal,
  MapPinned,
  Truck,
  PackageCheck,
  Database,
  ShoppingBag,
  BadgePercent,
  BarChart3,
  Users,
  PanelLeftClose,
  PanelLeftOpen,
  Globe,
  ShieldCheck,
  Clock3,
  Bell,
  UserCog,
} from "lucide-react";

import { Toaster as ShadcnToaster } from "@/components/ui/toaster";
import { Toaster as SonnerToaster } from "@/components/ui/sonner";
import "../styles/global.css";
import { DarkModeToggle } from "@/components/ui/DarkModeToggle";
import { Button } from "@/components/ui/button.tsx";
import SideBar from "@/components/admin/adminLayout/SideBar.astro";
import { generateAdminBreadcrumbs } from "@/lib/adminBreadCrumb";
import favicon from "@/assets/favicon.png";
import { PERMISSIONS } from "@/lib/rbac/permissions";

interface Props {
  title: string;
}

const { title } = Astro.props;

// Get current path
const currentPath = Astro.url.pathname;

// Get user and session from middleware
const user = Astro.locals.user;
const session = Astro.locals.session;

// Redirect to login if not authenticated
if (!user || !session) {
  return Astro.redirect("/auth/login");
}

// Firebase config setup
import { db } from "@/db";
import { settings } from "@/db/schema";
import { eq, and } from "drizzle-orm";

let firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
  measurementId: import.meta.env.PUBLIC_FIREBASE_MEASUREMENT_ID,
  vapidKey: import.meta.env.PUBLIC_VAPID_FIREBASE,
};

try {
  const result = await db
    .select({ value: settings.value })
    .from(settings)
    .where(and(eq(settings.key, "public_config"), eq(settings.category, "firebase")))
    .get();

  if (result && result.value) {
    const dbConfig = JSON.parse(result.value);
    // Merge DB config, overriding env vars if present
    firebaseConfig = { ...firebaseConfig, ...dbConfig };
    // Map vapidKey from likely json key "vapidKey"
    if (dbConfig.vapidKey) firebaseConfig.vapidKey = dbConfig.vapidKey;
  }
} catch (e) {
  console.error("Error loading Firebase settings in layout:", e);
}

// Generate breadcrumb items using helper function
const breadcrumbItems = generateAdminBreadcrumbs(currentPath);

// Define nav item types for type safety
interface NavSubItem {
  name: string;
  href: string;
  icon?: any;
  requiredPermission?: string;
  anyOfPermissions?: string[];
}
interface NavItem {
  name: string;
  href: string;
  icon: any;
  subItems?: NavSubItem[];
  requiredPermission?: string;
  anyOfPermissions?: string[];
}
interface NavSection {
  label: string;
  items: NavItem[];
}

// Prepare user data for UserMenu component
const userData = {
  id: user.id,
  name: user.name,
  email: user.email,
  image: user.image,
  role: user.role,
  twoFactorEnabled: user.twoFactorEnabled,
  isSuperAdmin: (user as any).isSuperAdmin ?? false,
};

// Get user permissions from middleware
const permissions = Astro.locals.permissions;
const permissionsArray = permissions ? Array.from(permissions) : [];

// Permission check helper for nav item filtering
const userIsSuperAdmin = userData.isSuperAdmin;

function hasNavPermission(item: NavItem | NavSubItem): boolean {
  if (userIsSuperAdmin) return true;
  if (!item.requiredPermission && !item.anyOfPermissions) return true;
  if (item.requiredPermission) {
    return permissions ? permissions.has(item.requiredPermission) : false;
  }
  if (item.anyOfPermissions) {
    return permissions ? item.anyOfPermissions.some((p: string) => permissions.has(p)) : false;
  }
  return true;
}

const allNavSections: NavSection[] = [
  {
    label: "Commerce",
    items: [
      { name: "Dashboard", href: "/admin", icon: LayoutDashboard, requiredPermission: PERMISSIONS.DASHBOARD_VIEW },
      { name: "Products", href: "/admin/products", icon: ShoppingCart, requiredPermission: PERMISSIONS.PRODUCTS_VIEW },
      { name: "Categories", href: "/admin/categories", icon: FolderTree, requiredPermission: PERMISSIONS.CATEGORIES_VIEW },
      { name: "Attributes", href: "/admin/attributes", icon: ListTree, requiredPermission: PERMISSIONS.ATTRIBUTES_VIEW },
      { name: "Collections", href: "/admin/collections", icon: Layers3, requiredPermission: PERMISSIONS.COLLECTIONS_VIEW },
      { name: "Media", href: "/admin/media", icon: Images, requiredPermission: PERMISSIONS.MEDIA_VIEW },
      { name: "Pages", href: "/admin/pages", icon: FileText, requiredPermission: PERMISSIONS.PAGES_VIEW },
      { name: "Widgets", href: "/admin/widgets", icon: Blocks, requiredPermission: PERMISSIONS.WIDGETS_VIEW },
    ],
  },
  {
    label: "Sales",
    items: [
      { name: "Orders", href: "/admin/orders", icon: ShoppingBag, requiredPermission: PERMISSIONS.ORDERS_VIEW },
      {
        name: "Incomplete Orders",
        href: "/admin/abandoned-checkouts",
        icon: Clock3,
        requiredPermission: PERMISSIONS.ORDERS_VIEW,
      },
      { name: "Discounts", href: "/admin/discounts", icon: BadgePercent, requiredPermission: PERMISSIONS.DISCOUNTS_VIEW },
      { name: "Analytics", href: "/admin/analytics", icon: BarChart3, requiredPermission: PERMISSIONS.ANALYTICS_VIEW },
      { name: "Customers", href: "/admin/customers", icon: Users, requiredPermission: PERMISSIONS.CUSTOMERS_VIEW },
    ],
  },
  {
    label: "Settings",
    items: [
      {
        name: "Settings",
        href: "/admin/settings",
        icon: Settings,
        // No permission on parent - it's a dropdown toggle, not a page link.
        // Visibility is determined by whether any sub-items are visible.
        // Account sub-item is always visible, so Settings always shows.
        subItems: [
          {
            name: "General",
            href: "/admin/settings",
            icon: SlidersHorizontal,
            requiredPermission: PERMISSIONS.SETTINGS_GENERAL_VIEW,
          },
          {
            name: "Account",
            href: "/admin/settings/account",
            icon: UserCog,
            // Account is always accessible - no permission required (own account management)
          },
          {
            name: "Notifications",
            href: "/admin/settings/notifications",
            icon: Bell,
            requiredPermission: PERMISSIONS.SETTINGS_NOTIFICATIONS_EDIT,
          },
          {
            name: "Hero Sliders",
            href: "/admin/settings/hero-sliders",
            icon: Images,
            requiredPermission: PERMISSIONS.SETTINGS_HEADER_EDIT,
          },
          {
            name: "Delivery Locations",
            href: "/admin/settings/delivery-locations",
            icon: MapPinned,
            requiredPermission: PERMISSIONS.SETTINGS_DELIVERY_LOCATIONS_VIEW,
          },
          {
            name: "Delivery Providers",
            href: "/admin/settings/delivery-providers",
            icon: Truck,
            requiredPermission: PERMISSIONS.SETTINGS_DELIVERY_PROVIDERS_VIEW,
          },
          {
            name: "Fraud Checker",
            href: "/admin/settings/fraud-checker",
            icon: ShieldCheck,
            requiredPermission: PERMISSIONS.SETTINGS_FRAUD_CHECKER_VIEW,
          },
          {
            name: "Shipping Methods",
            href: "/admin/settings/shipping-methods",
            icon: PackageCheck,
            requiredPermission: PERMISSIONS.SETTINGS_SHIPPING_METHODS_VIEW,
          },
          {
            name: "Checkout Languages",
            href: "/admin/settings/checkout-languages",
            icon: Globe,
            requiredPermission: PERMISSIONS.SETTINGS_GENERAL_VIEW,
          },
          {
            name: "Meta Conversions",
            href: "/admin/settings/meta-conversion",
            icon: BarChart3,
            requiredPermission: PERMISSIONS.SETTINGS_GENERAL_VIEW,
          },
          {
            name: "Cache Settings",
            href: "/admin/settings/cache",
            icon: Database,
            requiredPermission: PERMISSIONS.SETTINGS_CACHE_VIEW,
          },
        ],
      },
    ],
  },
];

// Filter nav sections based on user permissions
// Super admins see everything; other users only see items they have permission for
const navSections: NavSection[] = allNavSections
  .map((section) => ({
    ...section,
    items: section.items
      .filter((item) => hasNavPermission(item))
      .map((item) => {
        if (item.subItems) {
          return {
            ...item,
            subItems: item.subItems.filter((subItem) => hasNavPermission(subItem)),
          };
        }
        return item;
      })
      .filter((item) => !item.subItems || item.subItems.length > 0),
  }))
  .filter((section) => section.items.length > 0);
---

<html lang="en" class="antialiased">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      const theme = (() => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        // Default to light mode instead of following system preference
        return "light";
      })();

      if (theme === "light") {
        document.documentElement.classList.remove("dark");
      } else {
        document.documentElement.classList.add("dark");
      }
      document.documentElement.style.setProperty("color-scheme", theme);
    </script>
    <link rel="icon" type="image/png" href={favicon.src} />
    <meta name="generator" content={Astro.generator} />
    <title>{title} - Scalius Admin</title>
  </head>
  <body
    data-current-path={Astro.url.pathname}
    class="bg-background text-foreground transition-colors duration-200"
  >
    <div class="flex min-h-screen">
      <SideBar navSections={navSections} currentPath={currentPath} />

      <!-- Main content -->
      <div class="flex-1 flex flex-col min-h-screen">
        <!-- Header -->
        <header
          class="h-14 border-b border-border px-4 flex items-center justify-between sticky top-0 z-30 backdrop-blur-sm bg-background/95 transition-all duration-200"
        >
          <div class="flex items-center gap-3">
            <Button
              variant="ghost"
              size="icon"
              id="sidebar-toggle"
              aria-label="Toggle sidebar"
              className="md:hidden h-9 w-9 text-muted-foreground hover:text-foreground hover:bg-muted"
            >
              <Menu className="w-5! h-5!" />
            </Button>

            <Button
              variant="ghost"
              size="icon"
              id="sidebar-collapse"
              aria-label="Collapse sidebar"
              className="hidden md:flex h-8 w-8 text-muted-foreground hover:text-foreground hover:bg-muted"
            >
              <PanelLeftClose className="w-6! h-6! sidebar-icon-expanded" />
              <PanelLeftOpen
                className="w-6! h-6!  sidebar-icon-collapsed hidden"
              />
            </Button>

            <Breadcrumb items={breadcrumbItems} client:load />
          </div>
          <div class="flex items-center gap-12">
            <DarkModeToggle
              client:load
              className="h-8 w-8 p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md transition-colors"
            />
            <UserMenu user={userData} client:load />
          </div>
        </header>

        <!-- Main content area -->
        <main
          class="flex-1 p-6 transition-all duration-200"
          id="main-content"
        >
          <div class="max-w-7xl mx-auto">
            <slot />
          </div>
        </main>
      </div>
    </div>

    <ShadcnToaster client:load />
    <SonnerToaster richColors closeButton client:load />

    <script>
      function initializeSidebarControls() {
        const sidebarToggleBtn = document.getElementById("sidebar-toggle");
        const sidebarCollapseBtn = document.getElementById("sidebar-collapse");

        if (sidebarToggleBtn) {
          sidebarToggleBtn.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("toggleMobileSidebar"));
          });
        }

        if (sidebarCollapseBtn) {
          sidebarCollapseBtn.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("toggleSidebarCollapse"));
          });
        }
      }

      // Initialize immediately if DOM is ready, otherwise wait for it
      if (document.readyState === "loading") {
        document.addEventListener(
          "DOMContentLoaded",
          initializeSidebarControls
        );
      } else {
        initializeSidebarControls();
      }
    </script>

    <script define:vars={{ firebaseConfig, userId: user.id, permissions: permissionsArray, isSuperAdmin: userData.isSuperAdmin }}>
      // Store config in window for the module script to access
      window.__FIREBASE_CONFIG__ = firebaseConfig;
      window.__USER_ID__ = userId;
      // Store permissions for React components
      window.__USER_PERMISSIONS__ = permissions;
      window.__IS_SUPER_ADMIN__ = isSuperAdmin;
    </script>

    <script>
      // This script runs as a module (Firebase notifications)
      import { initFirebaseClientNotifications } from "@/lib/firebase/client";

      function initializeFcmOnClient() {
        console.log("AdminLayout: initializeFcmOnClient called");
        const firebaseConfig = (window as any).__FIREBASE_CONFIG__;
        const userId = (window as any).__USER_ID__;

        if (!firebaseConfig || !firebaseConfig.apiKey) {
          console.error("AdminLayout: Firebase config not found or invalid");
          return;
        }

        if (!userId) {
          console.warn("AdminLayout: User ID not available. FCM not initialized.");
          return;
        }

        console.log("AdminLayout: Initializing FCM with userId:", userId);
        initFirebaseClientNotifications(userId, firebaseConfig);
      }

      if (document.readyState === "complete") {
        initializeFcmOnClient();
      } else {
        window.addEventListener("load", initializeFcmOnClient);
      }
    </script>
  </body>
</html>
